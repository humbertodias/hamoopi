name: CD

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }} with ${{ matrix.backend }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        backend: [allegro, sdl2]
        include:
          - os: ubuntu-latest
            platform_name: linux
          - os: macos-latest
            platform_name: macos
          - os: windows-latest
            platform_name: windows
        exclude:
          # Exclude macOS + Allegro, only build SDL2 for macOS
          - os: macos-latest
            backend: allegro
          # Exclude Windows + Allegro
          - os: windows-latest
            backend: allegro

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # Linux dependencies
      - name: Install dependencies (Linux - Allegro)
        if: matrix.os == 'ubuntu-latest' && matrix.backend == 'allegro'
        run: |
          sudo apt-get update
          sudo apt-get install -y liballegro4-dev

      - name: Install dependencies (Linux - SDL2)
        if: matrix.os == 'ubuntu-latest' && matrix.backend == 'sdl2'
        run: |
          sudo apt-get update
          sudo apt-get install -y libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev libinih-dev qt6-base-dev

      # macOS dependencies
      - name: Install dependencies (macOS - Allegro)
        if: matrix.os == 'macos-latest' && matrix.backend == 'allegro'
        run: |
          brew install allegro@4

      - name: Install dependencies (macOS - SDL2)
        if: matrix.os == 'macos-latest' && matrix.backend == 'sdl2'
        run: |
          brew install sdl2 sdl2_image sdl2_mixer sdl2_ttf inih qt@6

      # Windows dependencies
      - name: Cache vcpkg packages (Windows - SDL2)
        if: matrix.os == 'windows-latest' && matrix.backend == 'sdl2'
        uses: actions/cache@v4
        with:
          path: |
            C:/vcpkg/installed
            C:/vcpkg/packages
          key: ${{ runner.os }}-vcpkg-sdl2-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-sdl2-
            ${{ runner.os }}-vcpkg-

      - name: Setup vcpkg (Windows - SDL2)
        if: matrix.os == 'windows-latest' && matrix.backend == 'sdl2'
        run: |
          vcpkg integrate install
          vcpkg install sdl2:x86-windows sdl2-image:x86-windows sdl2-mixer:x86-windows sdl2-ttf:x86-windows inih:x86-windows
        shell: bash

      - name: Install Qt6 (Windows - SDL2)
        if: matrix.os == 'windows-latest' && matrix.backend == 'sdl2'
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.*'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          cache: true

      - name: Install Allegro 4 manually (Windows)
        if: matrix.os == 'windows-latest' && matrix.backend == 'allegro'
        run: |
          # Download Allegro 4.4.2 binary for Windows
          curl -L -f https://master.dl.sourceforge.net/project/alleg/allegro-bin/4.2.2/allegro-mingw-4.2.2.zip?viasf=1 -o allegro.zip || {
            echo "Failed to download Allegro 4. Please verify the download URL."
            exit 1
          }
          # Create destination directory
          mkdir -p C:/allegro
          # Extract and organize files
          7z x allegro.zip -oC:/allegro-temp
          # Find the actual allegro directory and copy its contents
          if [ -d "C:/allegro-temp/allegro-mingw-4.2.2" ]; then
            cp -r C:/allegro-temp/allegro-mingw-4.2.2/* C:/allegro/
          elif [ -d "C:/allegro-temp/allegro" ]; then
            cp -r C:/allegro-temp/allegro/* C:/allegro/
          else
            # Fallback: just copy everything
            cp -r C:/allegro-temp/* C:/allegro/
          fi
          # List contents for debugging
          echo "Contents of C:/allegro:"
          ls -la C:/allegro/
          if [ -d "C:/allegro/include" ]; then
            echo "Include directory found"
            ls -la C:/allegro/include/
          fi
          if [ -d "C:/allegro/lib" ]; then
            echo "Lib directory found"
            ls -la C:/allegro/lib/
          fi
          # Set environment variables for CMake to find Allegro
          echo "ALLEGRO_ROOT=C:/allegro" >> $GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=C:/allegro" >> $GITHUB_ENV
        shell: bash

      # Build with Allegro
      - name: Build (Allegro)
        if: matrix.backend == 'allegro'
        run: |
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            # Use Win32 (x86) architecture for Windows Allegro builds
            cmake -B build -A Win32 -DUSE_SDL2=OFF
          else
            cmake -B build -DUSE_SDL2=OFF
          fi
          cmake --build build --config Release
        shell: bash

      # Build with SDL2
      - name: Build (SDL2)
        if: matrix.backend == 'sdl2'
        run: |
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            # Use Win32 (x86) architecture for Windows SDL2 builds to match vcpkg installation
            cmake -B build -A Win32 -DUSE_SDL2=ON -DBUILD_TOOLS=ON -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
          else
            cmake -B build -DUSE_SDL2=ON -DBUILD_TOOLS=ON
          fi
          cmake --build build --config Release
        shell: bash

      # Package artifacts
      - name: Package artifacts (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p artifacts
          # Copy executable (CMake post-build copies to root, but check build dir first)
          if [ -f "build/HAMOOPI" ]; then
            cp build/HAMOOPI artifacts/
          elif [ -f "HAMOOPI" ]; then
            cp HAMOOPI artifacts/
          else
            echo "Error: Executable not found"
            exit 1
          fi
          
          # Copy tools if they were built
          if [ "${{ matrix.backend }}" == "sdl2" ]; then
            # Copy pallete-generator (SDL2 backend)
            if [ -f "build/tools/pallete-generator/PALLETEGEN" ]; then
              cp build/tools/pallete-generator/PALLETEGEN artifacts/
              echo "Added PALLETEGEN to artifacts"
            fi
            
            # Copy font-generator (Qt6 based)
            if [ -f "build/tools/font-generator/TTF2PCX" ]; then
              cp build/tools/font-generator/TTF2PCX artifacts/
              echo "Added TTF2PCX to artifacts"
            fi
          fi
          
          # Copy data files
          cp -r data artifacts/
          cp LICENSE artifacts/
          cp README.md artifacts/
          cp SETUP.ini artifacts/
          
          # Copy shared libraries for SDL2 backend
          if [ "${{ matrix.backend }}" == "sdl2" ]; then
            echo "Copying SDL2 shared libraries..."
            mkdir -p artifacts/lib
            
            if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
              # Linux: Copy shared libraries
              # Find and copy SDL2 libraries
              for lib in libSDL2-2.0.so.0 libSDL2_image-2.0.so.0 libSDL2_mixer-2.0.so.0 libSDL2_ttf-2.0.so.0 libinih.so.0; do
                if [ -f "/usr/lib/x86_64-linux-gnu/$lib" ]; then
                  cp "/usr/lib/x86_64-linux-gnu/$lib" artifacts/lib/
                elif [ -f "/usr/lib/$lib" ]; then
                  cp "/usr/lib/$lib" artifacts/lib/
                else
                  echo "Warning: $lib not found"
                fi
              done
              
              # Create a launcher script that sets LD_LIBRARY_PATH
              {
                echo '#!/bin/bash'
                echo 'DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"'
                echo 'export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"'
                echo 'exec "$DIR/HAMOOPI" "$@"'
              } > artifacts/HAMOOPI.sh
              chmod +x artifacts/HAMOOPI.sh
              echo "Created launcher script HAMOOPI.sh"
              
            elif [ "${{ matrix.os }}" == "macos-latest" ]; then
              # macOS: Copy dylibs from Homebrew
              BREW_PREFIX=$(brew --prefix)
              echo "Homebrew prefix: $BREW_PREFIX"
              
              # Copy SDL2 frameworks/dylibs
              for lib in libSDL2-2.0.0.dylib libSDL2_image-2.0.0.dylib libSDL2_mixer-2.0.0.dylib libSDL2_ttf-2.0.0.dylib libinih.0.dylib; do
                if [ -f "$BREW_PREFIX/lib/$lib" ]; then
                  cp "$BREW_PREFIX/lib/$lib" artifacts/lib/
                  # Update the library path to use @rpath for better compatibility
                  chmod +w "artifacts/lib/$lib"
                  install_name_tool -id "@rpath/$lib" "artifacts/lib/$lib" 2>/dev/null || echo "Warning: Could not update install name for $lib"
                else
                  echo "Warning: $lib not found in $BREW_PREFIX/lib/"
                fi
              done
              
              # Update executable to use @rpath
              if [ -f "artifacts/HAMOOPI" ]; then
                chmod +w artifacts/HAMOOPI
                # Add @executable_path/lib to rpath
                install_name_tool -add_rpath "@executable_path/lib" artifacts/HAMOOPI 2>/dev/null || echo "Warning: Could not add rpath to executable"
                # Update library references in the executable
                for lib in libSDL2-2.0.0.dylib libSDL2_image-2.0.0.dylib libSDL2_mixer-2.0.0.dylib libSDL2_ttf-2.0.0.dylib libinih.0.dylib; do
                  install_name_tool -change "$BREW_PREFIX/lib/$lib" "@rpath/$lib" artifacts/HAMOOPI 2>/dev/null || true
                done
              fi
              
              # Create a launcher script as fallback for systems with SIP restrictions
              {
                echo '#!/bin/bash'
                echo 'DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"'
                echo '"$DIR/HAMOOPI" "$@" || {'
                echo '  export DYLD_LIBRARY_PATH="$DIR/lib:$DYLD_LIBRARY_PATH"'
                echo '  exec "$DIR/HAMOOPI" "$@"'
                echo '}'
              } > artifacts/HAMOOPI.sh
              chmod +x artifacts/HAMOOPI.sh
              echo "Created launcher script HAMOOPI.sh"
            fi
            
            echo "Shared library files in artifacts/lib:"
            ls -la artifacts/lib/ 2>/dev/null || echo "No library files found"
          fi
          
          # Create tarball
          cd artifacts
          tar czf ../HAMOOPI-${{ matrix.platform_name }}-${{ matrix.backend }}.tar.gz *
        shell: bash

      - name: Package artifacts (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          mkdir -p artifacts
          # Copy executable (check build dirs in order of likelihood)
          if [ -f "build/Release/HAMOOPI.exe" ]; then
            cp build/Release/HAMOOPI.exe artifacts/
          elif [ -f "build/HAMOOPI.exe" ]; then
            cp build/HAMOOPI.exe artifacts/
          elif [ -f "HAMOOPI.exe" ]; then
            cp HAMOOPI.exe artifacts/
          else
            echo "Error: Executable not found"
            exit 1
          fi
          
          # Copy tools if they were built (SDL2 backend only)
          if [ "${{ matrix.backend }}" == "sdl2" ]; then
            # Copy pallete-generator
            if [ -f "build/tools/pallete-generator/Release/PALLETEGEN.exe" ]; then
              cp build/tools/pallete-generator/Release/PALLETEGEN.exe artifacts/
              echo "Added PALLETEGEN.exe to artifacts"
            elif [ -f "build/tools/pallete-generator/PALLETEGEN.exe" ]; then
              cp build/tools/pallete-generator/PALLETEGEN.exe artifacts/
              echo "Added PALLETEGEN.exe to artifacts"
            fi
            
            # Copy font-generator
            if [ -f "build/tools/font-generator/Release/TTF2PCX.exe" ]; then
              cp build/tools/font-generator/Release/TTF2PCX.exe artifacts/
              echo "Added TTF2PCX.exe to artifacts"
            elif [ -f "build/tools/font-generator/TTF2PCX.exe" ]; then
              cp build/tools/font-generator/TTF2PCX.exe artifacts/
              echo "Added TTF2PCX.exe to artifacts"
            fi
            
            # Copy Qt6 DLLs for font-generator
            QT_BIN="$IQTA_TOOLS/../bin"
            if [ -d "$QT_BIN" ]; then
              cp "$QT_BIN/Qt6Core.dll" artifacts/ 2>/dev/null || echo "Warning: Qt6Core.dll not found"
              cp "$QT_BIN/Qt6Gui.dll" artifacts/ 2>/dev/null || echo "Warning: Qt6Gui.dll not found"
              cp "$QT_BIN/Qt6Widgets.dll" artifacts/ 2>/dev/null || echo "Warning: Qt6Widgets.dll not found"
              # Copy platform plugin
              mkdir -p artifacts/platforms
              cp "$QT_BIN/../plugins/platforms/qwindows.dll" artifacts/platforms/ 2>/dev/null || echo "Warning: qwindows.dll not found"
            fi
          fi
          
          # Copy data files
          cp -r data artifacts/
          cp LICENSE artifacts/
          cp README.md artifacts/
          cp SETUP.ini artifacts/
          
          # Copy SDL2 shared libraries for SDL2 backend
          if [ "${{ matrix.backend }}" == "sdl2" ]; then
            echo "Copying SDL2 DLLs from vcpkg..."
            # vcpkg installs DLLs in the installed/x86-windows/bin directory
            VCPKG_BIN="$VCPKG_INSTALLATION_ROOT/installed/x86-windows/bin"
            if [ -d "$VCPKG_BIN" ]; then
              cp "$VCPKG_BIN/SDL2.dll" artifacts/ 2>/dev/null || echo "Warning: SDL2.dll not found"
              cp "$VCPKG_BIN/SDL2_image.dll" artifacts/ 2>/dev/null || echo "Warning: SDL2_image.dll not found"
              cp "$VCPKG_BIN/SDL2_mixer.dll" artifacts/ 2>/dev/null || echo "Warning: SDL2_mixer.dll not found"
              cp "$VCPKG_BIN/SDL2_ttf.dll" artifacts/ 2>/dev/null || echo "Warning: SDL2_ttf.dll not found"
              cp "$VCPKG_BIN/inih.dll" artifacts/ 2>/dev/null || echo "Warning: inih.dll not found"
              # SDL2_image dependencies
              cp "$VCPKG_BIN/jpeg62.dll" artifacts/ 2>/dev/null || echo "Warning: jpeg62.dll not found"
              cp "$VCPKG_BIN/libpng16.dll" artifacts/ 2>/dev/null || echo "Warning: libpng16.dll not found"
              cp "$VCPKG_BIN/zlib1.dll" artifacts/ 2>/dev/null || echo "Warning: zlib1.dll not found"
              cp "$VCPKG_BIN/tiff.dll" artifacts/ 2>/dev/null || echo "Warning: tiff.dll not found"
              cp "$VCPKG_BIN/libwebp.dll" artifacts/ 2>/dev/null || echo "Warning: libwebp.dll not found"
              # SDL2_mixer dependencies
              cp "$VCPKG_BIN/libvorbis.dll" artifacts/ 2>/dev/null || echo "Warning: libvorbis.dll not found"
              cp "$VCPKG_BIN/libvorbisfile.dll" artifacts/ 2>/dev/null || echo "Warning: libvorbisfile.dll not found"
              cp "$VCPKG_BIN/libogg.dll" artifacts/ 2>/dev/null || echo "Warning: libogg.dll not found"
              cp "$VCPKG_BIN/libmodplug.dll" artifacts/ 2>/dev/null || echo "Warning: libmodplug.dll not found"
              cp "$VCPKG_BIN/libmpg123.dll" artifacts/ 2>/dev/null || echo "Warning: libmpg123.dll not found"
              cp "$VCPKG_BIN/libopus.dll" artifacts/ 2>/dev/null || echo "Warning: libopus.dll not found"
              cp "$VCPKG_BIN/libopusfile.dll" artifacts/ 2>/dev/null || echo "Warning: libopusfile.dll not found"
              cp "$VCPKG_BIN/libFLAC.dll" artifacts/ 2>/dev/null || echo "Warning: libFLAC.dll not found"
              # SDL2_ttf dependencies
              cp "$VCPKG_BIN/freetype.dll" artifacts/ 2>/dev/null || echo "Warning: freetype.dll not found"
              cp "$VCPKG_BIN/bz2.dll" artifacts/ 2>/dev/null || echo "Warning: bz2.dll not found"
              cp "$VCPKG_BIN/brotlicommon.dll" artifacts/ 2>/dev/null || echo "Warning: brotlicommon.dll not found"
              cp "$VCPKG_BIN/brotlidec.dll" artifacts/ 2>/dev/null || echo "Warning: brotlidec.dll not found"
              echo "DLL files in artifacts:"
              ls -la artifacts/*.dll 2>/dev/null || echo "No DLL files found in artifacts"
            else
              echo "Warning: vcpkg bin directory not found at $VCPKG_BIN"
            fi
          fi
          
          # Create zip for Windows
          cd artifacts
          7z a -tzip ../HAMOOPI-${{ matrix.platform_name }}-${{ matrix.backend }}.zip *
        shell: bash

      # Upload artifacts for all builds
      - name: Upload artifacts (Linux/macOS)
        if: matrix.os != 'windows-latest'
        uses: actions/upload-artifact@v5
        with:
          name: HAMOOPI-${{ matrix.platform_name }}-${{ matrix.backend }}
          path: HAMOOPI-${{ matrix.platform_name }}-${{ matrix.backend }}.tar.gz
          retention-days: 30

      - name: Upload artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v5
        with:
          name: HAMOOPI-${{ matrix.platform_name }}-${{ matrix.backend }}
          path: HAMOOPI-${{ matrix.platform_name }}-${{ matrix.backend }}.zip
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          
      - name: Display structure of downloaded files
        run: ls -R artifacts
        
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
